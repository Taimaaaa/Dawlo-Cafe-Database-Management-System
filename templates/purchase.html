{% extends "base.html" %}
{% block content %}

<!-- ================= PURCHASE HEADER ================= -->
<div class="card">
  <h2>Purchase #{{ purchase.purchase_id }}</h2>

  <p>
    Status: <b>{{ purchase.purchase_status }}</b>
  </p>

  <p>
    Payment:
    <b>
      {% if payment_status == 'paid' %}
        Paid
      {% elif payment_status == 'partially_paid' %}
        Partially Paid (Remaining {{ remaining_amount }})
      {% else %}
        Unpaid
      {% endif %}
    </b>
  </p>

  <p>Total: <b>{{ purchase.total_cost }}</b></p>
</div>

<!-- ================= ADD ITEM ================= -->
<div class="card">
  <h3>➕ Add Item</h3>

  {% if purchase.purchase_status == 'draft' %}
    <form method="post">
      <input type="hidden" name="action" value="add">

      <select name="warehouse_item_id" required>
        {% for w in warehouse_items %}
          <option value="{{ w.item_id }}">
            {{ w.item_name }} ({{ w.unit_of_measure }})
          </option>
        {% endfor %}
      </select>

      <input type="number" name="quantity" min="0.01" step="0.01" required>
      <button>Add</button>
    </form>
  {% else %}
    <p class="empty">Items can only be added while purchase is in draft.</p>
  {% endif %}
</div>

<!-- ================= ITEMS ================= -->
<div class="card">
  <h3>Items</h3>

  {% if items %}
    <ul>
  {% for i in items %}
    <li style="display:flex; align-items:center; gap:10px;">
      <span>
        {{ i.item_name }}
        × {{ i.quantity }} {{ i.unit_of_measure }}
        = {{ i.quantity * i.unit_price }}
      </span>

      {% if purchase.purchase_status == 'draft' %}
        <form method="post" style="display:inline;">
          <input type="hidden" name="action" value="decrement">
          <input type="hidden" name="warehouse_item_id" value="{{ i.warehouse_item_id }}">
          <button type="submit" class="btn-small danger">-1</button>
        </form>
      {% endif %}
    </li>
  {% endfor %}
</ul>

  {% else %}
    <p class="empty">No items added yet.</p>
  {% endif %}
</div>

<!-- ================= ACTIONS ================= -->
<div class="card">
  <h3>Actions</h3>

  <!-- Cancel: ONLY in draft -->
  {% if purchase.purchase_status == 'draft' %}
    <form method="post" style="display:inline;"
          onsubmit="return confirm('Cancel this purchase?');">
      <input type="hidden" name="action" value="cancel">
      <button class="danger">Cancel Purchase</button>
    </form>
  {% endif %}

  <!-- Confirm -->
  {% if purchase.purchase_status == 'draft' and items %}
    <form method="post" style="display:inline;">
      <button name="action" value="confirm">
        Confirm Purchase
      </button>
    </form>
  {% endif %}

  <!-- Deliver -->
  {% if purchase.purchase_status == 'confirmed' %}
    <form method="post" style="display:inline;">
      <button name="action" value="deliver">
        Mark Delivered
      </button>
    </form>
  {% endif %}
</div>

<!-- ================= PAYMENT ================= -->
{% if purchase.purchase_status in ['confirmed', 'delivered']
      and payment_status != 'paid' %}
<div class="card">
  <h3>Payment</h3>

  <form method="post">
    <input type="hidden" name="action" value="pay">

    <label>Method</label>
    <select name="method" required>
      <option value="cash">Cash</option>
      <option value="card">Card</option>
    </select>

    <label>Payment Type</label>
    <select name="payment_kind" id="payment_kind" required>
      <option value="full">Full Payment</option>
      <option value="partial">Partial Payment</option>
    </select>

    <div id="partial_amount" style="display:none;">
      <label>Amount</label>
      <input type="number"
             name="amount"
             min="0.01"
             max="{{ remaining_amount }}"
             step="0.01">
    </div>

    <button>Pay</button>
  </form>
</div>
{% endif %}

<!-- ================= SUCCESS MESSAGE ================= -->
{% if message == 'paid' %}
<div class="card">
  <p class="success">✅ Payment recorded successfully.</p>
</div>
{% endif %}

<script>
  const kind = document.getElementById("payment_kind");
  const partialBox = document.getElementById("partial_amount");

  if (kind && partialBox) {
    kind.addEventListener("change", () => {
      partialBox.style.display =
        kind.value === "partial" ? "block" : "none";
    });
  }
</script>

{% endblock %}
