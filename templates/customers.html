{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Customers</h2>

  <!-- TOP TOOLBAR -->
  <div class="customer-toolbar">

    <a href="{{ url_for('add_customer') }}" class="btn-secondary">
      + Add New Customer
    </a>

    <!-- SORT DROPDOWN (RIGHT SIDE) -->
    <form method="get" class="sort-form">
      <label>Sort</label>

      <select name="sort" onchange="this.form.submit()">
        <option value="id" {{ 'selected' if sort_by == 'id' }}>ID</option>
        <option value="name" {{ 'selected' if sort_by == 'name' }}>Name</option>
        <option value="phone" {{ 'selected' if sort_by == 'phone' }}>Phone</option>
        <option value="email" {{ 'selected' if sort_by == 'email' }}>Email</option>
      </select>

      <!-- keep order -->
      <input type="hidden" name="order" value="{{ order }}">

      <!-- preserve search -->
      {% if request.args.get('field') %}
        <input type="hidden" name="field" value="{{ request.args.get('field') }}">
      {% endif %}
      {% if request.args.get('search') %}
        <input type="hidden" name="search" value="{{ request.args.get('search') }}">
      {% endif %}
    </form>

  </div>

  <!-- SEARCH BAR -->
  <form method="get" class="search-bar">

    <select name="field" required>
      <option value="customer_id"
        {% if request.args.get('field') == 'customer_id' %}selected{% endif %}>
        ID
      </option>

      <option value="customer_name"
        {% if request.args.get('field') == 'customer_name' %}selected{% endif %}>
        Name
      </option>

      <option value="phone_number"
        {% if request.args.get('field') == 'phone_number' %}selected{% endif %}>
        Phone
      </option>

      <option value="email"
        {% if request.args.get('field') == 'email' %}selected{% endif %}>
        Email
      </option>
    </select>

    <input
      type="text"
      name="search"
      placeholder="Search..."
      value="{{ request.args.get('search', '') }}"
      required
    >

    <!-- preserve sorting -->
    <input type="hidden" name="sort" value="{{ sort_by }}">
    <input type="hidden" name="order" value="{{ order }}">
  </form>

  <!-- TABLE -->
  <table>
    <thead>
      <tr>

        <th>
          <a href="{{ url_for('customers_list',
                sort='id',
                order='desc' if sort_by=='id' and order=='asc' else 'asc',
                field=request.args.get('field'),
                search=request.args.get('search')) }}">
            ID
            {% if sort_by == 'id' %}
              {{ '▲' if order == 'asc' else '▼' }}
            {% endif %}
          </a>
        </th>

        <th>
          <a href="{{ url_for('customers_list',
                sort='name',
                order='desc' if sort_by=='name' and order=='asc' else 'asc',
                field=request.args.get('field'),
                search=request.args.get('search')) }}">
            Name
            {% if sort_by == 'name' %}
              {{ '▲' if order == 'asc' else '▼' }}
            {% endif %}
          </a>
        </th>

        <th>
          <a href="{{ url_for('customers_list',
                sort='phone',
                order='desc' if sort_by=='phone' and order=='asc' else 'asc',
                field=request.args.get('field'),
                search=request.args.get('search')) }}">
            Phone
            {% if sort_by == 'phone' %}
              {{ '▲' if order == 'asc' else '▼' }}
            {% endif %}
          </a>
        </th>

        <th>
          <a href="{{ url_for('customers_list',
                sort='email',
                order='desc' if sort_by=='email' and order=='asc' else 'asc',
                field=request.args.get('field'),
                search=request.args.get('search')) }}">
            Email
            {% if sort_by == 'email' %}
              {{ '▲' if order == 'asc' else '▼' }}
            {% endif %}
          </a>
        </th>

        <th></th>
      </tr>
    </thead>

    <tbody>
      {% for c in customers %}
      <tr>
        <td>{{ c.customer_id }}</td>
        <td>{{ c.customer_name }}</td>
        <td>{{ c.phone_number }}</td>
        <td>{{ c.email }}</td>
        <td>
          <a href="{{ url_for('edit_customer', customer_id=c.customer_id) }}"
             class="btn-secondary">
            Edit
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if customers|length == 0 %}
    <p class="empty">No customers found.</p>
  {% endif %}

  {% if request.args.get('search') %}
    <a href="{{ url_for('customers_list') }}" class="btn-secondary">
      ← Back to Customers
    </a>
  {% endif %}

</div>

{% endblock %}
