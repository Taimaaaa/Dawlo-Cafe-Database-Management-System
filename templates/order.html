{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>ðŸ§¾ Order #{{ order.order_id }}</h2>
  <p>Status: <b>{{ order.order_status }}</b></p>
  <p>Total: <b>{{ order.total }}</b></p>
</div>

<div class="card">
  <h3>âž• Add Item</h3>

  {% if not paid %}
  <form method="post">
    <input type="hidden" name="action" value="add">

    <select name="menu_item_id">
      {% for m in menu_items %}
        <option value="{{ m.item_id }}">{{ m.item_name }} ({{ m.price }})</option>
      {% endfor %}
    </select>

    <input type="number" name="quantity" min="1" required>
    <button>Add</button>
  </form>
  {% else %}
    <p class="empty">Order is paid. No changes allowed.</p>
  {% endif %}
</div>

<div class="card">
  <h3>Items</h3>

  {% if items %}
  <ul>
    {% for i in items %}
      <li>
        {{ i.item_name }} Ã— {{ i.quantity }} = {{ i.subtotal }}

        {% if not paid %}
          <form method="post" style="display:inline;">
            <input type="hidden" name="action" value="decrement_item">
            <input type="hidden" name="menu_item_id" value="{{ i.menu_item_id }}">
            <button>-1</button>
          </form>

          <form method="post" style="display:inline;"
                onsubmit="return confirm('Remove this item?');">
            <input type="hidden" name="action" value="remove_item">
            <input type="hidden" name="menu_item_id" value="{{ i.menu_item_id }}">
            <button class="danger">Remove</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% else %}
    <p class="empty">No items added yet.</p>
  {% endif %}
</div>

<div class="card">
  <h3>Actions</h3>

  <form method="post" style="display:inline;">
    <button name="action" value="served">Mark Served</button>
  </form>

  {% if not paid %}
  <form method="post" style="display:inline;">
    <input type="hidden" name="action" value="pay">
    <select name="method">
      <option value="cash">Cash</option>
      <option value="card">Card</option>
    </select>
    <button>Pay</button>
  </form>

  <form method="post" onsubmit="return confirm('Delete entire order?');">
    <input type="hidden" name="action" value="delete_order">
    <button class="danger">Delete Order</button>
  </form>
  {% endif %}
</div>
<div id="receiptFlag" data-open="{{ 1 if message == 'paid' else 0 }}"></div>

<!-- RECEIPT MODAL -->
<div id="receiptModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeReceipt()">âœ•</button>
    <iframe src="/receipt/{{ order.order_id }}"></iframe>
  </div>
</div>

<script>
function closeReceipt() {
  document.getElementById("receiptModal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", function () {
  const flag = document.getElementById("receiptFlag");
  const shouldOpenReceipt = flag && flag.dataset.open === "1";

  if (shouldOpenReceipt) {
    document.getElementById("receiptModal").style.display = "flex";
  }
});
</script>

 <hr>

  <h3>Assigned Employees</h3>

  {% if assigned_employees %}
    <ul>
      {% for e in assigned_employees %}
        <li>
          {{ e.emp_name }} â€” {{ e.position_title }}

          {% if not paid %}
          <form method="post" style="display:inline;">
            <input type="hidden" name="action" value="remove_employee">
            <input type="hidden" name="emp_id" value="{{ e.emp_id }}">
            <button class="btn small danger">Remove</button>
          </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No employees assigned yet.</p>
  {% endif %}

  <!-- ================= ASSIGN EMPLOYEE ================= -->
  {% if not paid and available_employees %}
    <h4>Assign Employee</h4>

    <form method="post">
      <input type="hidden" name="action" value="assign_employee">

      <select name="emp_id" required>
        {% for e in available_employees %}
          <option value="{{ e.emp_id }}">
            {{ e.emp_name }} ({{ e.position_title }})
          </option>
        {% endfor %}
      </select>

      <button class="btn">Assign</button>
    </form>
  {% endif %}

</div>

{% endblock %}