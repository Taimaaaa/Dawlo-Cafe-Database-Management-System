{% extends "base.html" %}
{% block content %}

<!-- ================= ORDER HEADER ================= -->
<div class="card">
  <h2>üßæ Order #{{ order.order_id }}</h2>
  <p>Status: <b>{{ order.order_status }}</b></p>
  <p>Total: <b>{{ order.total }}</b></p>
</div>

<!-- ================= ADD ITEM ================= -->
<div class="card">
  <h3>‚ûï Add Item</h3>

  {% if order.order_status == 'cancelled' %}
    <div class="alert danger">
      ‚ùå This order has been cancelled. No changes allowed.
    </div>
  {% endif %}

  {% if not paid and order.order_status != 'cancelled' %}
  <form method="post">
    <input type="hidden" name="action" value="add">

    <select name="menu_item_id" required>
      {% for m in menu_items %}
        <option value="{{ m.item_id }}">{{ m.item_name }} ({{ m.price }})</option>
      {% endfor %}
    </select>

    <input type="number" name="quantity" min="1" required>
    <button>Add</button>
  </form>
  {% elif paid %}
    <p class="empty">Order is paid. No changes allowed.</p>
  {% endif %}
</div>

<!-- ================= ITEMS ================= -->
<div class="card">
  <h3>Items</h3>

  {% if items %}
  <ul>
    {% for i in items %}
      <li>
        {{ i.item_name }} √ó {{ i.quantity }} = {{ i.subtotal }}

        <span class="badge">{{ i.item_status|upper }}</span>

        {% if not paid and order.order_status != 'cancelled' %}

          {% if i.item_status == 'ordered' %}
            <!-- -1 -->
            <form method="post" style="display:inline;">
              <input type="hidden" name="action" value="decrement_item">
              <input type="hidden" name="menu_item_id" value="{{ i.menu_item_id }}">
              <button>-1</button>
            </form>

            <!-- cancel item -->
            <form method="post" style="display:inline;"
                  onsubmit="return confirm('Cancel this item?');">
              <input type="hidden" name="action" value="cancel_item">
              <input type="hidden" name="menu_item_id" value="{{ i.menu_item_id }}">
              <button class="danger small">Cancel</button>
            </form>
          {% endif %}

          {% if i.item_status == 'cancelled' %}
            <!-- uncancel -->
            <form method="post" style="display:inline;">
              <input type="hidden" name="action" value="uncancel_item">
              <input type="hidden" name="menu_item_id" value="{{ i.menu_item_id }}">
              <button>Uncancel</button>
            </form>
          {% endif %}

        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% else %}
    <p class="empty">No items added yet.</p>
  {% endif %}
</div>

<!-- ================= ACTIONS ================= -->
<div class="card">
  <h3>Actions</h3>

  {% if order.order_status == 'ordered' %}
    <form method="post" style="display:inline;">
      <button name="action" value="served">Mark Served</button>
    </form>

    <form method="post" style="display:inline;"
          onsubmit="return confirm('Cancel the order?');">
      <input type="hidden" name="action" value="cancel_order">
      <button class="danger">Cancel Order</button>
    </form>
  {% endif %}

  {% if not paid and order.order_status in ['ordered', 'served'] %}
    <form method="post" style="display:inline;">
      <input type="hidden" name="action" value="pay">
      <select name="method">
        <option value="cash">Cash</option>
        <option value="card">Card</option>
      </select>
      <button>Pay</button>
    </form>
  {% endif %}
</div>

<!-- ================= RECEIPT ================= -->
<div id="receiptFlag" data-open="{{ 1 if message == 'paid' else 0 }}"></div>

<div id="receiptModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeReceipt()">‚úï</button>
    <iframe src="/receipt/{{ order.order_id }}"></iframe>
  </div>
</div>

<script>
function closeReceipt() {
  document.getElementById("receiptModal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", function () {
  const flag = document.getElementById("receiptFlag");
  if (flag && flag.dataset.open === "1") {
    document.getElementById("receiptModal").style.display = "flex";
  }
});
</script>

<hr>

<!-- ================= EMPLOYEES ================= -->
<h3>Assigned Employees</h3>

{% if assigned_employees %}
  <ul>
    {% for e in assigned_employees %}
      <li>
        {{ e.emp_name }} ‚Äî {{ e.position_title }}

        {% if not paid and order.order_status == 'ordered' %}
        <form method="post" style="display:inline;">
          <input type="hidden" name="action" value="remove_employee">
          <input type="hidden" name="emp_id" value="{{ e.emp_id }}">
          <button class="btn small danger">Remove</button>
        </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="muted">No employees assigned yet.</p>
{% endif %}

{% if not paid and order.order_status == 'ordered' and available_employees %}
<h4>Assign Employee</h4>

<form method="post" action="{{ url_for('assign_employee') }}">
  <input type="hidden" name="order_id" value="{{ order.order_id }}">

  <select name="emp_id" required>
    {% for e in available_employees %}
      <option value="{{ e.emp_id }}">
        {{ e.emp_name }} ({{ e.position_title }})
      </option>
    {% endfor %}
  </select>

  <select name="role" required>
    <option value="server">Server</option>
    <option value="barista">Barista</option>
    <option value="cashier">Cashier</option>
    <option value="kitchen">Kitchen</option>
  </select>

  <button class="btn">Assign</button>
</form>
{% endif %}

{% endblock %}
